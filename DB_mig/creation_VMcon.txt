# setting variables
RESOURCE_GROUP="mysql-migration-rg"
LOCATION="southeastasia"
VNET_NAME="mysqlMigrationVNet"
SUBNET_NAME="mysqlSubnet"
ADDRESS_PREFIX="10.0.0.0/16"
SUBNET_PREFIX="10.0.0.0/24"
MYSQL_NAME="mysql-server123"
MYSQL_ADMIN="bnguyen"
MYSQL_PASSWORD=".Tldccmcbtldck2"

# create resource group
az group create --name $RESOURCE_GROUP --location $LOCATION

# create virtual network and subnet
az network vnet create \
  --name $VNET_NAME \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION \
  --address-prefix $ADDRESS_PREFIX \
  --subnet-name $SUBNET_NAME \
  --subnet-prefix $SUBNET_PREFIX

# get subnet id (subnet id in SUBNET_ID)
SUBNET_ID=$(az network vnet subnet show \
--resource-group mysql-migration-rg \
--vnet-name mysqlMigrationVNet \
--name mysqlSubnet \
--query id --output tsv)

# Register 
az provider register --namespace Microsoft.DBforMySQL

# create database in azure with vnet
az mysql flexible-server create \
  --name online-store-cloud-database \
  --resource-group mysql-migration-rg \
  --location southeastasia \
  --admin-user bnguyen \
  --admin-password .Tldccmcbtldck2 \
  --subnet $SUBNET_ID \
  --private-dns-zone mysqlprivatednszone.mysql.database.azure.com \
  --sku-name Standard_D2ds_v4 \
  --tier GeneralPurpose \
  --storage-size 50

# Create subnet for the VM
az network vnet subnet create \
  --resource-group mysql-migration-rg \
  --vnet-name mysqlMigrationVNet \
  --name vmSubnet \
  --address-prefix 10.0.1.0/24

# Create a VM inside the vnet (VM password: .Tldccmcbtldck2)
az vm create \
  --resource-group mysql-migration-rg \
  --name mysql-admin-vm2 \
  --image Ubuntu2204 \
  --size Standard_B1s \
  --vnet-name mysqlMigrationVNet \
  --subnet vmSubnet \
  --admin-username azureuser \
  --ssh-key-values ~/.ssh/id_rsa.pub \
  --public-ip-sku Standard \
  --authentication-type ssh


  # Find public ip of local machine
  curl -s https://ipv4.icanhazip.com

  # Rule to access SSH for certain ip (NSG rule)
  az network nsg rule create \
  --resource-group mysql-migration-rg \
  --nsg-name mysql-admin-vmNSG \
  --name AllowSSH \
  --priority 1001 \
  --direction Inbound \
  --access Allow \
  --protocol Tcp \
  --destination-port-ranges 22 \
  --source-address-prefixes 171.242.189.56 \
  --destination-address-prefixes '*'

#Generate SSH key
ssh-keygen -t rsa -b 2048

# Connect to VM via SSH (replace with the vm public ip)
ssh azureuser@4.194.150.191

# connect to azure db
mysql -h online-store-cloud-database.mysql.database.azure.com -P 3306 -u bnguyen -p








